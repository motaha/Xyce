      subroutine vbic_4T_it_xf_fj(p,Vbei,Vbex,Vbci,Vbep,Vbcp,Vrxf,Vrcx
     +,Vbcx,Vrci,Vrbx,Vrbi,Vre,Vrbp,Vrs,Vbe,Vbc,Vcxf,Ibe,Ibe_Vbei,Ibex
     +,Ibex_Vbex,Itxf,Itxf_Vrxf,Itzr,Itzr_Vbci,Itzr_Vbei,Ibc,Ibc_Vbci
     +,Ibc_Vrxf,Ibc_Vbei,Ibep,Ibep_Vbep,Ircx,Ircx_Vrcx,Irci,Irci_Vrci
     +,Irci_Vbci,Irci_Vbcx,Irbx,Irbx_Vrbx,Irbi,Irbi_Vrbi,Irbi_Vbei
     +,Irbi_Vbci,Ire,Ire_Vre,Irbp,Irbp_Vrbp,Irbp_Vbep,Irbp_Vbci,Qbe
     +,Qbe_Vbei,Qbe_Vbci,Qbex,Qbex_Vbex,Qbc,Qbc_Vbci,Qbcx,Qbcx_Vbcx,Qbep
     +,Qbep_Vbep,Qbep_Vbci,Qbeo,Qbeo_Vbe,Qbco,Qbco_Vbc,Ibcp,Ibcp_Vbcp
     +,Iccp,Iccp_Vbep,Iccp_Vbci,Iccp_Vbcp,Irs,Irs_Vrs,Qbcp,Qbcp_Vbcp
     +,Ixzf,Ixzf_Vbei,Ixzf_Vbci,Ixxf,Ixxf_Vrxf,Qcxf,Qcxf_Vcxf,Flxf
     +,Flxf_Vrxf,SCALE)
      implicit double precision (a-z)
      double precision p(108)
c
c     Map parameter array into symbolic names
c
      TNOM=p(1)
      RCX=p(2)
      RCI=p(3)
      VO=p(4)
      GAMM=p(5)
      HRCF=p(6)
      RBX=p(7)
      RBI=p(8)
      RE=p(9)
      RS=p(10)
      RBP=p(11)
      IS=p(12)
      NF=p(13)
      NR=p(14)
      FC=p(15)
      CBEO=p(16)
      CJE=p(17)
      PE=p(18)
      ME=p(19)
      AJE=p(20)
      CBCO=p(21)
      CJC=p(22)
      QCO=p(23)
      CJEP=p(24)
      PC=p(25)
      MC=p(26)
      AJC=p(27)
      CJCP=p(28)
      PS=p(29)
      MS=p(30)
      AJS=p(31)
      IBEI=p(32)
      WBE=p(33)
      NEI=p(34)
      IBEN=p(35)
      NEN=p(36)
      IBCI=p(37)
      NCI=p(38)
      IBCN=p(39)
      NCN=p(40)
      AVC1=p(41)
      AVC2=p(42)
      ISP=p(43)
      WSP=p(44)
      NFP=p(45)
      IBEIP=p(46)
      IBENP=p(47)
      IBCIP=p(48)
      NCIP=p(49)
      IBCNP=p(50)
      NCNP=p(51)
      VEF=p(52)
      VER=p(53)
      IKF=p(54)
      IKR=p(55)
      IKP=p(56)
      TF=p(57)
      QTF=p(58)
      XTF=p(59)
      VTF=p(60)
      ITF=p(61)
      TR=p(62)
      TD=p(63)
      VRT=p(86)
      ART=p(87)
      CCSO=p(88)
      QBM=p(89)
      NKF=p(90)
      ISRR=p(95)
      VBBE=p(99)
      NBBE=p(100)
      IBBE=p(101)
      EBBE=p(105)
c
c     Function and derivative code
c
      Vtv=1.380662e-23*(2.731500e+02+TNOM)/1.602189e-19
      if(VEF.GT.0.0)then
         IVEF=1.0/VEF
      else
         IVEF=0.0
      endif
      if(VER.GT.0.0)then
         IVER=1.0/VER
      else
         IVER=0.0
      endif
      if(IKF.GT.0.0)then
         IIKF=1.0/IKF
      else
         IIKF=0.0
      endif
      if(IKR.GT.0.0)then
         IIKR=1.0/IKR
      else
         IIKR=0.0
      endif
      if(IKP.GT.0.0)then
         IIKP=1.0/IKP
      else
         IIKP=0.0
      endif
      if(VO.GT.0.0)then
         IVO=1.0/VO
      else
         IVO=0.0
      endif
      if(HRCF.GT.0.0)then
         IHRCF=1.0/HRCF
      else
         IHRCF=0.0
      endif
      if(VTF.GT.0.0)then
         IVTF=1.0/VTF
      else
         IVTF=0.0
      endif
      if(ITF.GT.0.0)then
         IITF=1.0/ITF
      else
         IITF=0.0
      endif
      if(ITF.GT.0.0)then
         slTF=0.0
      else
         slTF=1.0
      endif
      if(TD.GT.0.0)then
         LEP=TD/3.0
      else
         LEP=0.0
      endif
      if(TD.GT.0.0)then
         CEP=TD
      else
         CEP=0.0
      endif
      dv0=-PE*FC
      if(AJE.LE.0.0)then
         dvh=Vbei+dv0
         dvh_Vbei=1.0
         if(dvh.GT.0.0)then
            xvar1=(1.0-FC)
            xvar2=(-1.0-ME)
            pwq=xvar1**xvar2
            qlo=PE*(1.0-pwq*(1.0-FC)*(1.0-FC))/(1.0-ME)
            qlo_Vbei=0.0
            qhi=dvh*(1.0-FC+0.5*ME*dvh/PE)*pwq
            qhi_dvh=(0.5*dvh*ME/PE-FC+1.0)*pwq+0.5*dvh*ME*pwq/PE
            qhi_Vbei=qhi_dvh*dvh_Vbei
         else
            xvar1=(1.0-Vbei/PE)
            xvar1_Vbei=-1.0/PE
            xvar2=(1.0-ME)
            xvar3=xvar1**xvar2
            xvar3_xvar1=xvar3*xvar2/xvar1
            xvar3_Vbei=xvar3_xvar1*xvar1_Vbei
            qlo=PE*(1.0-xvar3)/(1.0-ME)
            qlo_xvar3=-PE/(1.0-ME)
            qlo_Vbei=qlo_xvar3*xvar3_Vbei
            qhi=0.0
            qhi_Vbei=0.0
         endif
         qdbe=qlo+qhi
         qdbe_qlo=1.0
         qdbe_qhi=1.0
         qdbe_Vbei=qdbe_qlo*qlo_Vbei
         qdbe_Vbei=qdbe_Vbei+qdbe_qhi*qhi_Vbei
      else
         mv0=sqrt(dv0*dv0+4.0*AJE*AJE)
         vl0=-0.5*(dv0+mv0)
         xvar1=(1.0-vl0/PE)
         xvar2=(1.0-ME)
         xvar3=xvar1**xvar2
         q0=-PE*xvar3/(1.0-ME)
         dv=Vbei+dv0
         dv_Vbei=1.0
         mv=sqrt(dv*dv+4.0*AJE*AJE)
         mv_dv=dv/sqrt((dv*dv)+4.0*(AJE*AJE))
         mv_Vbei=mv_dv*dv_Vbei
         vl=0.5*(dv-mv)-dv0
         vl_dv=0.5
         vl_mv=-0.5
         vl_Vbei=vl_dv*dv_Vbei
         vl_Vbei=vl_Vbei+vl_mv*mv_Vbei
         xvar1=(1.0-vl/PE)
         xvar1_vl=-1.0/PE
         xvar1_Vbei=xvar1_vl*vl_Vbei
         xvar2=(1.0-ME)
         xvar3=xvar1**xvar2
         xvar3_xvar1=xvar3*xvar2/xvar1
         xvar3_Vbei=xvar3_xvar1*xvar1_Vbei
         qlo=-PE*xvar3/(1.0-ME)
         qlo_xvar3=-PE/(1.0-ME)
         qlo_Vbei=qlo_xvar3*xvar3_Vbei
         xvar1=(1.0-FC)
         xvar2=(-ME)
         xvar3=xvar1**xvar2
         qdbe=qlo+xvar3*(Vbei-vl+vl0)-q0
         qdbe_qlo=1.0
         qdbe_Vbei=xvar3
         qdbe_vl=-xvar3
         qdbe_Vbei=qdbe_Vbei+qdbe_qlo*qlo_Vbei
         qdbe_Vbei=qdbe_Vbei+qdbe_vl*vl_Vbei
      endif
      dv0=-PE*FC
      if(AJE.LE.0.0)then
         dvh=Vbex+dv0
         dvh_Vbex=1.0
         if(dvh.GT.0.0)then
            xvar1=(1.0-FC)
            xvar2=(-1.0-ME)
            pwq=xvar1**xvar2
            qlo=PE*(1.0-pwq*(1.0-FC)*(1.0-FC))/(1.0-ME)
            qlo_Vbex=0.0
            qhi=dvh*(1.0-FC+0.5*ME*dvh/PE)*pwq
            qhi_dvh=(0.5*dvh*ME/PE-FC+1.0)*pwq+0.5*dvh*ME*pwq/PE
            qhi_Vbex=qhi_dvh*dvh_Vbex
         else
            xvar1=(1.0-Vbex/PE)
            xvar1_Vbex=-1.0/PE
            xvar2=(1.0-ME)
            xvar3=xvar1**xvar2
            xvar3_xvar1=xvar3*xvar2/xvar1
            xvar3_Vbex=xvar3_xvar1*xvar1_Vbex
            qlo=PE*(1.0-xvar3)/(1.0-ME)
            qlo_xvar3=-PE/(1.0-ME)
            qlo_Vbex=qlo_xvar3*xvar3_Vbex
            qhi=0.0
            qhi_Vbex=0.0
         endif
         qdbex=qlo+qhi
         qdbex_qlo=1.0
         qdbex_qhi=1.0
         qdbex_Vbex=qdbex_qlo*qlo_Vbex
         qdbex_Vbex=qdbex_Vbex+qdbex_qhi*qhi_Vbex
      else
         mv0=sqrt(dv0*dv0+4.0*AJE*AJE)
         vl0=-0.5*(dv0+mv0)
         xvar1=(1.0-vl0/PE)
         xvar2=(1.0-ME)
         xvar3=xvar1**xvar2
         q0=-PE*xvar3/(1.0-ME)
         dv=Vbex+dv0
         dv_Vbex=1.0
         mv=sqrt(dv*dv+4.0*AJE*AJE)
         mv_dv=dv/sqrt((dv*dv)+4.0*(AJE*AJE))
         mv_Vbex=mv_dv*dv_Vbex
         vl=0.5*(dv-mv)-dv0
         vl_dv=0.5
         vl_mv=-0.5
         vl_Vbex=vl_dv*dv_Vbex
         vl_Vbex=vl_Vbex+vl_mv*mv_Vbex
         xvar1=(1.0-vl/PE)
         xvar1_vl=-1.0/PE
         xvar1_Vbex=xvar1_vl*vl_Vbex
         xvar2=(1.0-ME)
         xvar3=xvar1**xvar2
         xvar3_xvar1=xvar3*xvar2/xvar1
         xvar3_Vbex=xvar3_xvar1*xvar1_Vbex
         qlo=-PE*xvar3/(1.0-ME)
         qlo_xvar3=-PE/(1.0-ME)
         qlo_Vbex=qlo_xvar3*xvar3_Vbex
         xvar1=(1.0-FC)
         xvar2=(-ME)
         xvar3=xvar1**xvar2
         qdbex=qlo+xvar3*(Vbex-vl+vl0)-q0
         qdbex_qlo=1.0
         qdbex_Vbex=xvar3
         qdbex_vl=-xvar3
         qdbex_Vbex=qdbex_Vbex+qdbex_qlo*qlo_Vbex
         qdbex_Vbex=qdbex_Vbex+qdbex_vl*vl_Vbex
      endif
      dv0=-PC*FC
      if(AJC.LE.0.0)then
         dvh=Vbci+dv0
         dvh_Vbci=1.0
         if(dvh.GT.0.0)then
            xvar1=(1.0-FC)
            xvar2=(-1.0-MC)
            pwq=xvar1**xvar2
            qlo=PC*(1.0-pwq*(1.0-FC)*(1.0-FC))/(1.0-MC)
            qlo_Vbci=0.0
            qhi=dvh*(1.0-FC+0.5*MC*dvh/PC)*pwq
            qhi_dvh=(0.5*dvh*MC/PC-FC+1.0)*pwq+0.5*dvh*MC*pwq/PC
            qhi_Vbci=qhi_dvh*dvh_Vbci
         else
            if((VRT.GT.0.0).AND.(Vbci.LT.-VRT))then
               xvar1=(1.0+VRT/PC)
               xvar2=(1.0-MC)
               xvar3=xvar1**xvar2
               qlo=PC*(1.0-xvar3*(1.0-((1.0-MC)*(Vbci+VRT))/(PC+VRT)))/(
     +1.0-MC)
               qlo_Vbci=PC*xvar3/(VRT+PC)
            else
               xvar1=(1.0-Vbci/PC)
               xvar1_Vbci=-1.0/PC
               xvar2=(1.0-MC)
               xvar3=xvar1**xvar2
               xvar3_xvar1=xvar3*xvar2/xvar1
               xvar3_Vbci=xvar3_xvar1*xvar1_Vbci
               qlo=PC*(1.0-xvar3)/(1.0-MC)
               qlo_xvar3=-PC/(1.0-MC)
               qlo_Vbci=qlo_xvar3*xvar3_Vbci
            endif
            qhi=0.0
            qhi_Vbci=0.0
         endif
         qdbc=qlo+qhi
         qdbc_qlo=1.0
         qdbc_qhi=1.0
         qdbc_Vbci=qdbc_qlo*qlo_Vbci
         qdbc_Vbci=qdbc_Vbci+qdbc_qhi*qhi_Vbci
      else
         if((VRT.GT.0.0).AND.(ART.GT.0.0))then
            vn0=(VRT+dv0)/(VRT-dv0)
            vnl0=2.0*vn0/(sqrt((vn0-1.0)*(vn0-1.0)+4.0*AJC*AJC)+sqrt((vn
     +0+1.0)*(vn0+1.0)+4.0*ART*ART))
            vl0=0.5*(vnl0*(VRT-dv0)-VRT-dv0)
            xvar1=(1.0-vl0/PC)
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            qlo0=PC*(1.0-xvar3)/(1.0-MC)
            vn=(2.0*Vbci+VRT+dv0)/(VRT-dv0)
            vn_Vbci=2.0/(VRT-dv0)
            vnl=2.0*vn/(sqrt((vn-1.0)*(vn-1.0)+4.0*AJC*AJC)+sqrt((vn+1.0
     +)*(vn+1.0)+4.0*ART*ART))
            vnl_vn=2.0/(sqrt(((vn+1.0)*(vn+1.0))+4.0*(ART*ART))+sqrt(((v
     +n-1.0)*(vn-1.0))+4.0*(AJC*AJC)))-2.0*vn*((vn+1.0)/sqrt(((vn+1.0)*(
     +vn+1.0))+4.0*(ART*ART))+(vn-1.0)/sqrt(((vn-1.0)*(vn-1.0))+4.0*(AJC
     +*AJC)))/((sqrt(((vn+1.0)*(vn+1.0))+4.0*(ART*ART))+sqrt(((vn-1.0)*(
     +vn-1.0))+4.0*(AJC*AJC)))*(sqrt(((vn+1.0)*(vn+1.0))+4.0*(ART*ART))+
     +sqrt(((vn-1.0)*(vn-1.0))+4.0*(AJC*AJC))))
            vnl_Vbci=vnl_vn*vn_Vbci
            vl=0.5*(vnl*(VRT-dv0)-VRT-dv0)
            vl_vnl=0.5*(VRT-dv0)
            vl_Vbci=vl_vnl*vnl_Vbci
            xvar1=(1.0-vl/PC)
            xvar1_vl=-1.0/PC
            xvar1_Vbci=xvar1_vl*vl_Vbci
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            xvar3_xvar1=xvar3*xvar2/xvar1
            xvar3_Vbci=xvar3_xvar1*xvar1_Vbci
            qlo=PC*(1.0-xvar3)/(1.0-MC)
            qlo_xvar3=-PC/(1.0-MC)
            qlo_Vbci=qlo_xvar3*xvar3_Vbci
            sel=0.5*(vnl+1.0)
            sel_vnl=0.5
            sel_Vbci=sel_vnl*vnl_Vbci
            xvar1=(1.0+VRT/PC)
            xvar2=(-MC)
            crt=xvar1**xvar2
            xvar1=(1.0+dv0/PC)
            xvar2=(-MC)
            cmx=xvar1**xvar2
            cl=(1.0-sel)*crt+sel*cmx
            cl_sel=cmx-crt
            cl_Vbci=cl_sel*sel_Vbci
            ql=(Vbci-vl+vl0)*cl
            ql_Vbci=cl
            ql_vl=-cl
            ql_cl=vl0-vl+Vbci
            ql_Vbci=ql_Vbci+ql_vl*vl_Vbci
            ql_Vbci=ql_Vbci+ql_cl*cl_Vbci
            qdbc=ql+qlo-qlo0
            qdbc_ql=1.0
            qdbc_qlo=1.0
            qdbc_Vbci=qdbc_ql*ql_Vbci
            qdbc_Vbci=qdbc_Vbci+qdbc_qlo*qlo_Vbci
         else
            mv0=sqrt(dv0*dv0+4.0*AJC*AJC)
            vl0=-0.5*(dv0+mv0)
            xvar1=(1.0-vl0/PC)
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            q0=-PC*xvar3/(1.0-MC)
            dv=Vbci+dv0
            dv_Vbci=1.0
            mv=sqrt(dv*dv+4.0*AJC*AJC)
            mv_dv=dv/sqrt((dv*dv)+4.0*(AJC*AJC))
            mv_Vbci=mv_dv*dv_Vbci
            vl=0.5*(dv-mv)-dv0
            vl_dv=0.5
            vl_mv=-0.5
            vl_Vbci=vl_dv*dv_Vbci
            vl_Vbci=vl_Vbci+vl_mv*mv_Vbci
            xvar1=(1.0-vl/PC)
            xvar1_vl=-1.0/PC
            xvar1_Vbci=xvar1_vl*vl_Vbci
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            xvar3_xvar1=xvar3*xvar2/xvar1
            xvar3_Vbci=xvar3_xvar1*xvar1_Vbci
            qlo=-PC*xvar3/(1.0-MC)
            qlo_xvar3=-PC/(1.0-MC)
            qlo_Vbci=qlo_xvar3*xvar3_Vbci
            xvar1=(1.0-FC)
            xvar2=(-MC)
            xvar3=xvar1**xvar2
            qdbc=qlo+xvar3*(Vbci-vl+vl0)-q0
            qdbc_qlo=1.0
            qdbc_Vbci=xvar3
            qdbc_vl=-xvar3
            qdbc_Vbci=qdbc_Vbci+qdbc_qlo*qlo_Vbci
            qdbc_Vbci=qdbc_Vbci+qdbc_vl*vl_Vbci
         endif
      endif
      dv0=-PC*FC
      if(AJC.LE.0.0)then
         dvh=Vbep+dv0
         dvh_Vbep=1.0
         if(dvh.GT.0.0)then
            xvar1=(1.0-FC)
            xvar2=(-1.0-MC)
            pwq=xvar1**xvar2
            qlo=PC*(1.0-pwq*(1.0-FC)*(1.0-FC))/(1.0-MC)
            qlo_Vbep=0.0
            qhi=dvh*(1.0-FC+0.5*MC*dvh/PC)*pwq
            qhi_dvh=(0.5*dvh*MC/PC-FC+1.0)*pwq+0.5*dvh*MC*pwq/PC
            qhi_Vbep=qhi_dvh*dvh_Vbep
         else
            if((VRT.GT.0.0).AND.(Vbep.LT.-VRT))then
               xvar1=(1.0+VRT/PC)
               xvar2=(1.0-MC)
               xvar3=xvar1**xvar2
               qlo=PC*(1.0-xvar3*(1.0-((1.0-MC)*(Vbep+VRT))/(PC+VRT)))/(
     +1.0-MC)
               qlo_Vbep=PC*xvar3/(VRT+PC)
            else
               xvar1=(1.0-Vbep/PC)
               xvar1_Vbep=-1.0/PC
               xvar2=(1.0-MC)
               xvar3=xvar1**xvar2
               xvar3_xvar1=xvar3*xvar2/xvar1
               xvar3_Vbep=xvar3_xvar1*xvar1_Vbep
               qlo=PC*(1.0-xvar3)/(1.0-MC)
               qlo_xvar3=-PC/(1.0-MC)
               qlo_Vbep=qlo_xvar3*xvar3_Vbep
            endif
            qhi=0.0
            qhi_Vbep=0.0
         endif
         qdbep=qlo+qhi
         qdbep_qlo=1.0
         qdbep_qhi=1.0
         qdbep_Vbep=qdbep_qlo*qlo_Vbep
         qdbep_Vbep=qdbep_Vbep+qdbep_qhi*qhi_Vbep
      else
         if((VRT.GT.0.0).AND.(ART.GT.0.0))then
            vn0=(VRT+dv0)/(VRT-dv0)
            vnl0=2.0*vn0/(sqrt((vn0-1.0)*(vn0-1.0)+4.0*AJC*AJC)+sqrt((vn
     +0+1.0)*(vn0+1.0)+4.0*ART*ART))
            vl0=0.5*(vnl0*(VRT-dv0)-VRT-dv0)
            xvar1=(1.0-vl0/PC)
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            qlo0=PC*(1.0-xvar3)/(1.0-MC)
            vn=(2.0*Vbep+VRT+dv0)/(VRT-dv0)
            vn_Vbep=2.0/(VRT-dv0)
            vnl=2.0*vn/(sqrt((vn-1.0)*(vn-1.0)+4.0*AJC*AJC)+sqrt((vn+1.0
     +)*(vn+1.0)+4.0*ART*ART))
            vnl_vn=2.0/(sqrt(((vn+1.0)*(vn+1.0))+4.0*(ART*ART))+sqrt(((v
     +n-1.0)*(vn-1.0))+4.0*(AJC*AJC)))-2.0*vn*((vn+1.0)/sqrt(((vn+1.0)*(
     +vn+1.0))+4.0*(ART*ART))+(vn-1.0)/sqrt(((vn-1.0)*(vn-1.0))+4.0*(AJC
     +*AJC)))/((sqrt(((vn+1.0)*(vn+1.0))+4.0*(ART*ART))+sqrt(((vn-1.0)*(
     +vn-1.0))+4.0*(AJC*AJC)))*(sqrt(((vn+1.0)*(vn+1.0))+4.0*(ART*ART))+
     +sqrt(((vn-1.0)*(vn-1.0))+4.0*(AJC*AJC))))
            vnl_Vbep=vnl_vn*vn_Vbep
            vl=0.5*(vnl*(VRT-dv0)-VRT-dv0)
            vl_vnl=0.5*(VRT-dv0)
            vl_Vbep=vl_vnl*vnl_Vbep
            xvar1=(1.0-vl/PC)
            xvar1_vl=-1.0/PC
            xvar1_Vbep=xvar1_vl*vl_Vbep
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            xvar3_xvar1=xvar3*xvar2/xvar1
            xvar3_Vbep=xvar3_xvar1*xvar1_Vbep
            qlo=PC*(1.0-xvar3)/(1.0-MC)
            qlo_xvar3=-PC/(1.0-MC)
            qlo_Vbep=qlo_xvar3*xvar3_Vbep
            sel=0.5*(vnl+1.0)
            sel_vnl=0.5
            sel_Vbep=sel_vnl*vnl_Vbep
            xvar1=(1.0+VRT/PC)
            xvar2=(-MC)
            crt=xvar1**xvar2
            xvar1=(1.0+dv0/PC)
            xvar2=(-MC)
            cmx=xvar1**xvar2
            cl=(1.0-sel)*crt+sel*cmx
            cl_sel=cmx-crt
            cl_Vbep=cl_sel*sel_Vbep
            ql=(Vbep-vl+vl0)*cl
            ql_Vbep=cl
            ql_vl=-cl
            ql_cl=vl0-vl+Vbep
            ql_Vbep=ql_Vbep+ql_vl*vl_Vbep
            ql_Vbep=ql_Vbep+ql_cl*cl_Vbep
            qdbep=ql+qlo-qlo0
            qdbep_ql=1.0
            qdbep_qlo=1.0
            qdbep_Vbep=qdbep_ql*ql_Vbep
            qdbep_Vbep=qdbep_Vbep+qdbep_qlo*qlo_Vbep
         else
            mv0=sqrt(dv0*dv0+4.0*AJC*AJC)
            vl0=-0.5*(dv0+mv0)
            xvar1=(1.0-vl0/PC)
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            q0=-PC*xvar3/(1.0-MC)
            dv=Vbep+dv0
            dv_Vbep=1.0
            mv=sqrt(dv*dv+4.0*AJC*AJC)
            mv_dv=dv/sqrt((dv*dv)+4.0*(AJC*AJC))
            mv_Vbep=mv_dv*dv_Vbep
            vl=0.5*(dv-mv)-dv0
            vl_dv=0.5
            vl_mv=-0.5
            vl_Vbep=vl_dv*dv_Vbep
            vl_Vbep=vl_Vbep+vl_mv*mv_Vbep
            xvar1=(1.0-vl/PC)
            xvar1_vl=-1.0/PC
            xvar1_Vbep=xvar1_vl*vl_Vbep
            xvar2=(1.0-MC)
            xvar3=xvar1**xvar2
            xvar3_xvar1=xvar3*xvar2/xvar1
            xvar3_Vbep=xvar3_xvar1*xvar1_Vbep
            qlo=-PC*xvar3/(1.0-MC)
            qlo_xvar3=-PC/(1.0-MC)
            qlo_Vbep=qlo_xvar3*xvar3_Vbep
            xvar1=(1.0-FC)
            xvar2=(-MC)
            xvar3=xvar1**xvar2
            qdbep=qlo+xvar3*(Vbep-vl+vl0)-q0
            qdbep_qlo=1.0
            qdbep_Vbep=xvar3
            qdbep_vl=-xvar3
            qdbep_Vbep=qdbep_Vbep+qdbep_qlo*qlo_Vbep
            qdbep_Vbep=qdbep_Vbep+qdbep_vl*vl_Vbep
         endif
      endif
      if(CJCP.GT.0.0)then
         dv0=-PS*FC
         if(AJS.LE.0.0)then
            dvh=Vbcp+dv0
            dvh_Vbcp=1.0
            if(dvh.GT.0.0)then
               xvar1=(1.0-FC)
               xvar2=(-1.0-MS)
               pwq=xvar1**xvar2
               qlo=PS*(1.0-pwq*(1.0-FC)*(1.0-FC))/(1.0-MS)
               qlo_Vbep=0.0
               qlo_Vbcp=0.0
               qhi=dvh*(1.0-FC+0.5*MS*dvh/PS)*pwq
               qhi_dvh=(0.5*dvh*MS/PS-FC+1.0)*pwq+0.5*dvh*MS*pwq/PS
               qhi_Vbep=0.0
               qhi_Vbcp=qhi_dvh*dvh_Vbcp
            else
               xvar1=(1.0-Vbcp/PS)
               xvar1_Vbcp=-1.0/PS
               xvar2=(1.0-MS)
               xvar3=xvar1**xvar2
               xvar3_xvar1=xvar3*xvar2/xvar1
               xvar3_Vbcp=xvar3_xvar1*xvar1_Vbcp
               qlo=PS*(1.0-xvar3)/(1.0-MS)
               qlo_xvar3=-PS/(1.0-MS)
               qlo_Vbep=0.0
               qlo_Vbcp=qlo_xvar3*xvar3_Vbcp
               qhi=0.0
               qhi_Vbep=0.0
               qhi_Vbcp=0.0
            endif
            qdbcp=qlo+qhi
            qdbcp_qlo=1.0
            qdbcp_qhi=1.0
            qdbcp_Vbcp=qdbcp_qlo*qlo_Vbcp
            qdbcp_Vbep=qdbcp_qlo*qlo_Vbep
            qdbcp_Vbep=qdbcp_Vbep+qdbcp_qhi*qhi_Vbep
            qdbcp_Vbcp=qdbcp_Vbcp+qdbcp_qhi*qhi_Vbcp
         else
            mv0=sqrt(dv0*dv0+4.0*AJS*AJS)
            vl0=-0.5*(dv0+mv0)
            xvar1=(1.0-vl0/PS)
            xvar2=(1.0-MS)
            xvar3=xvar1**xvar2
            q0=-PS*xvar3/(1.0-MS)
            dv=Vbcp+dv0
            dv_Vbcp=1.0
            mv=sqrt(dv*dv+4.0*AJS*AJS)
            mv_dv=dv/sqrt((dv*dv)+4.0*(AJS*AJS))
            mv_Vbcp=mv_dv*dv_Vbcp
            vl=0.5*(dv-mv)-dv0
            vl_dv=0.5
            vl_mv=-0.5
            vl_Vbcp=vl_dv*dv_Vbcp
            vl_Vbcp=vl_Vbcp+vl_mv*mv_Vbcp
            xvar1=(1.0-vl/PS)
            xvar1_vl=-1.0/PS
            xvar1_Vbcp=xvar1_vl*vl_Vbcp
            xvar2=(1.0-MS)
            xvar3=xvar1**xvar2
            xvar3_xvar1=xvar3*xvar2/xvar1
            xvar3_Vbcp=xvar3_xvar1*xvar1_Vbcp
            qlo=-PS*xvar3/(1.0-MS)
            qlo_xvar3=-PS/(1.0-MS)
            qlo_Vbep=0.0
            qlo_Vbcp=qlo_xvar3*xvar3_Vbcp
            xvar1=(1.0-FC)
            xvar2=(-MS)
            xvar3=xvar1**xvar2
            qdbcp=qlo+xvar3*(Vbcp-vl+vl0)-q0
            qdbcp_qlo=1.0
            qdbcp_Vbcp=xvar3
            qdbcp_vl=-xvar3
            qdbcp_Vbcp=qdbcp_Vbcp+qdbcp_qlo*qlo_Vbcp
            qdbcp_Vbep=qdbcp_qlo*qlo_Vbep
            qdbcp_Vbcp=qdbcp_Vbcp+qdbcp_vl*vl_Vbcp
         endif
      else
         qdbcp=0.0
         qdbcp_Vbcp=0.0
      endif
      argi=Vbei/(NF*Vtv)
      argi_Vbei=1.0/(NF*Vtv)
      expi=exp(argi)
      expi_argi=expi
      expi_Vbei=expi_argi*argi_Vbei
      Ifi=IS*(expi-1.0)
      Ifi_expi=IS
      Ifi_Vbei=Ifi_expi*expi_Vbei
      argi=Vbci/(NR*Vtv)
      argi_Vbci=1.0/(NR*Vtv)
      expi=exp(argi)
      expi_argi=expi
      expi_Vbci=expi_argi*argi_Vbci
      Iri=IS*ISRR*(expi-1.0)
      Iri_expi=IS*ISRR
      Iri_Vbci=Iri_expi*expi_Vbci
      q1z=1.0+qdbe*IVER+qdbc*IVEF
      q1z_qdbe=IVER
      q1z_qdbc=IVEF
      q1z_Vbei=q1z_qdbe*qdbe_Vbei
      q1z_Vbci=q1z_qdbc*qdbc_Vbci
      q1=0.5*(sqrt((q1z-1.0e-4)*(q1z-1.0e-4)+1.0e-8)+q1z-1.0e-4)+1.0e-4
      q1_q1z=0.5*((q1z-1.0e-4)/sqrt(((q1z-1.0e-4)*(q1z-1.0e-4))+1.0e-8)+
     +1.0)
      q1_Vbei=q1_q1z*q1z_Vbei
      q1_Vbci=q1_q1z*q1z_Vbci
      q2=Ifi*IIKF+Iri*IIKR
      q2_Ifi=IIKF
      q2_Iri=IIKR
      q2_Vbei=q2_Ifi*Ifi_Vbei
      q2_Vbci=q2_Iri*Iri_Vbci
      if(QBM.LT.0.5)then
         xvar2=1.0/NKF
         xvar3=q1**xvar2
         xvar3_q1=xvar3*xvar2/q1
         xvar3_Vbei=xvar3_q1*q1_Vbei
         xvar3_Vbci=xvar3_q1*q1_Vbci
         xvar1=(xvar3+4.0*q2)
         xvar1_xvar3=1.0
         xvar1_q2=4.0
         xvar1_Vbei=xvar1_xvar3*xvar3_Vbei
         xvar1_Vbci=xvar1_xvar3*xvar3_Vbci
         xvar1_Vbei=xvar1_Vbei+xvar1_q2*q2_Vbei
         xvar1_Vbci=xvar1_Vbci+xvar1_q2*q2_Vbci
         xvar4=xvar1**NKF
         xvar4_xvar1=xvar4*NKF/xvar1
         xvar4_Vbei=xvar4_xvar1*xvar1_Vbei
         xvar4_Vbci=xvar4_xvar1*xvar1_Vbci
         qb=0.5*(q1+xvar4)
         qb_q1=0.5
         qb_xvar4=0.5
         qb_Vbei=qb_q1*q1_Vbei
         qb_Vbci=qb_q1*q1_Vbci
         qb_Vbei=qb_Vbei+qb_xvar4*xvar4_Vbei
         qb_Vbci=qb_Vbci+qb_xvar4*xvar4_Vbci
      else
         xvar1=(1.0+4.0*q2)
         xvar1_q2=4.0
         xvar1_Vbei=xvar1_q2*q2_Vbei
         xvar1_Vbci=xvar1_q2*q2_Vbci
         xvar2=xvar1**NKF
         xvar2_xvar1=xvar2*NKF/xvar1
         xvar2_Vbei=xvar2_xvar1*xvar1_Vbei
         xvar2_Vbci=xvar2_xvar1*xvar1_Vbci
         qb=0.5*q1*(1.0+xvar2)
         qb_q1=0.5*(xvar2+1.0)
         qb_xvar2=0.5*q1
         qb_Vbei=qb_q1*q1_Vbei
         qb_Vbci=qb_q1*q1_Vbci
         qb_Vbei=qb_Vbei+qb_xvar2*xvar2_Vbei
         qb_Vbci=qb_Vbci+qb_xvar2*xvar2_Vbci
      endif
      Itzr=Iri/qb
      Itzr_Iri=1.0/qb
      Itzr_qb=-Iri/(qb*qb)
      Itzr_Vbci=Itzr_Iri*Iri_Vbci
      Itzr_Vbei=Itzr_qb*qb_Vbei
      Itzr_Vbci=Itzr_Vbci+Itzr_qb*qb_Vbci
      Itzf=Ifi/qb
      Itzf_Ifi=1.0/qb
      Itzf_qb=-Ifi/(qb*qb)
      Itzf_Vbei=Itzf_Ifi*Ifi_Vbei
      Itzf_Vbei=Itzf_Vbei+Itzf_qb*qb_Vbei
      Itzf_Vbci=Itzf_qb*qb_Vbci
      Ixzf=-Itzf
      Ixzf_Itzf=-1.0
      Ixzf_Vbei=Ixzf_Itzf*Itzf_Vbei
      Ixzf_Vbci=Ixzf_Itzf*Itzf_Vbci
      Itxf=Vrxf
      Itxf_Vrxf=1.0
      Ixxf=Vrxf
      Ixxf_Vrxf=1.0
      if(ISP.GT.0.0)then
         argi=Vbep/(NFP*Vtv)
         argi_Vbep=1.0/(NFP*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbep=expi_argi*argi_Vbep
         argx=Vbci/(NFP*Vtv)
         argx_Vbci=1.0/(NFP*Vtv)
         expx=exp(argx)
         expx_argx=expx
         expx_Vbci=expx_argx*argx_Vbci
         Ifp=ISP*(WSP*expi+(1.0-WSP)*expx-1.0)
         Ifp_expi=ISP*WSP
         Ifp_expx=ISP*(1.0-WSP)
         Ifp_Vbep=Ifp_expi*expi_Vbep
         Ifp_Vbci=Ifp_expx*expx_Vbci
         q2p=Ifp*IIKP
         q2p_Ifp=IIKP
         q2p_Vbep=q2p_Ifp*Ifp_Vbep
         q2p_Vbci=q2p_Ifp*Ifp_Vbci
         qbp=0.5*(1.0+sqrt(1.0+4.0*q2p))
         qbp_q2p=1.0/sqrt(4.0*q2p+1.0)
         qbp_Vbep=qbp_q2p*q2p_Vbep
         qbp_Vbci=qbp_q2p*q2p_Vbci
         argi=Vbcp/(NFP*Vtv)
         argi_Vbcp=1.0/(NFP*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbcp=expi_argi*argi_Vbcp
         Irp=ISP*(expi-1.0)
         Irp_expi=ISP
         Irp_Vbcp=Irp_expi*expi_Vbcp
         Iccp=(Ifp-Irp)/qbp
         Iccp_Ifp=1.0/qbp
         Iccp_Irp=-1.0/qbp
         Iccp_qbp=-(Ifp-Irp)/(qbp*qbp)
         Iccp_Vbep=Iccp_Ifp*Ifp_Vbep
         Iccp_Vbci=Iccp_Ifp*Ifp_Vbci
         Iccp_Vbcp=Iccp_Irp*Irp_Vbcp
         Iccp_Vbep=Iccp_Vbep+Iccp_qbp*qbp_Vbep
         Iccp_Vbci=Iccp_Vbci+Iccp_qbp*qbp_Vbci
      else
         Ifp=0.0
         Ifp_Vbep=0.0
         Ifp_Vbci=0.0
         qbp=1.0
         qbp_Vbep=0.0
         qbp_Vbci=0.0
         Iccp=0.0
         Iccp_Vbep=0.0
         Iccp_Vbci=0.0
         Iccp_Vbcp=0.0
      endif
      if(WBE.EQ.1.0)then
         argi=Vbei/(NEI*Vtv)
         argi_Vbei=1.0/(NEI*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbei=expi_argi*argi_Vbei
         argn=Vbei/(NEN*Vtv)
         argn_Vbei=1.0/(NEN*Vtv)
         expn=exp(argn)
         expn_argn=expn
         expn_Vbei=expn_argn*argn_Vbei
         if(VBBE.GT.0.0)then
            argx=(-VBBE-Vbei)/(NBBE*Vtv)
            argx_Vbei=-1.0/(NBBE*Vtv)
            expx=exp(argx)
            expx_argx=expx
            expx_Vbei=expx_argx*argx_Vbei
            Ibe=IBEI*(expi-1.0)+IBEN*(expn-1.0)-IBBE*(expx-EBBE)
            Ibe_expi=IBEI
            Ibe_expn=IBEN
            Ibe_expx=-IBBE
            Ibe_Vbei=Ibe_expi*expi_Vbei
            Ibe_Vbei=Ibe_Vbei+Ibe_expn*expn_Vbei
            Ibe_Vbei=Ibe_Vbei+Ibe_expx*expx_Vbei
         else
            Ibe=IBEI*(expi-1.0)+IBEN*(expn-1.0)
            Ibe_expi=IBEI
            Ibe_expn=IBEN
            Ibe_Vbei=Ibe_expi*expi_Vbei
            Ibe_Vbei=Ibe_Vbei+Ibe_expn*expn_Vbei
         endif
         Ibex=0.0
         Ibex_Vbex=0.0
      elseif(WBE.EQ.0.0)then
         Ibe=0.0
         Ibe_Vbei=0.0
         argi=Vbex/(NEI*Vtv)
         argi_Vbex=1.0/(NEI*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbex=expi_argi*argi_Vbex
         argn=Vbex/(NEN*Vtv)
         argn_Vbex=1.0/(NEN*Vtv)
         expn=exp(argn)
         expn_argn=expn
         expn_Vbex=expn_argn*argn_Vbex
         if(VBBE.GT.0.0)then
            argx=(-VBBE-Vbex)/(NBBE*Vtv)
            argx_Vbex=-1.0/(NBBE*Vtv)
            expx=exp(argx)
            expx_argx=expx
            expx_Vbex=expx_argx*argx_Vbex
            Ibex=IBEI*(expi-1.0)+IBEN*(expn-1.0)-IBBE*(expx-EBBE)
            Ibex_expi=IBEI
            Ibex_expn=IBEN
            Ibex_expx=-IBBE
            Ibex_Vbex=Ibex_expi*expi_Vbex
            Ibex_Vbex=Ibex_Vbex+Ibex_expn*expn_Vbex
            Ibex_Vbex=Ibex_Vbex+Ibex_expx*expx_Vbex
         else
            Ibex=IBEI*(expi-1.0)+IBEN*(expn-1.0)
            Ibex_expi=IBEI
            Ibex_expn=IBEN
            Ibex_Vbex=Ibex_expi*expi_Vbex
            Ibex_Vbex=Ibex_Vbex+Ibex_expn*expn_Vbex
         endif
      else
         argi=Vbei/(NEI*Vtv)
         argi_Vbei=1.0/(NEI*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbei=expi_argi*argi_Vbei
         argn=Vbei/(NEN*Vtv)
         argn_Vbei=1.0/(NEN*Vtv)
         expn=exp(argn)
         expn_argn=expn
         expn_Vbei=expn_argn*argn_Vbei
         if(VBBE.GT.0.0)then
            argx=(-VBBE-Vbei)/(NBBE*Vtv)
            argx_Vbei=-1.0/(NBBE*Vtv)
            expx=exp(argx)
            expx_argx=expx
            expx_Vbei=expx_argx*argx_Vbei
            Ibe=WBE*(IBEI*(expi-1.0)+IBEN*(expn-1.0)-IBBE*(expx-EBBE))
            Ibe_expi=IBEI*WBE
            Ibe_expn=IBEN*WBE
            Ibe_expx=-IBBE*WBE
            Ibe_Vbei=Ibe_expi*expi_Vbei
            Ibe_Vbei=Ibe_Vbei+Ibe_expn*expn_Vbei
            Ibe_Vbei=Ibe_Vbei+Ibe_expx*expx_Vbei
         else
            Ibe=WBE*(IBEI*(expi-1.0)+IBEN*(expn-1.0))
            Ibe_expi=IBEI*WBE
            Ibe_expn=IBEN*WBE
            Ibe_Vbei=Ibe_expi*expi_Vbei
            Ibe_Vbei=Ibe_Vbei+Ibe_expn*expn_Vbei
         endif
         argi=Vbex/(NEI*Vtv)
         argi_Vbex=1.0/(NEI*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbex=expi_argi*argi_Vbex
         argn=Vbex/(NEN*Vtv)
         argn_Vbex=1.0/(NEN*Vtv)
         expn=exp(argn)
         expn_argn=expn
         expn_Vbex=expn_argn*argn_Vbex
         if(VBBE.GT.0.0)then
            argx=(-VBBE-Vbex)/(NBBE*Vtv)
            argx_Vbex=-1.0/(NBBE*Vtv)
            expx=exp(argx)
            expx_argx=expx
            expx_Vbex=expx_argx*argx_Vbex
            Ibex=(1.0-WBE)*(IBEI*(expi-1.0)+IBEN*(expn-1.0)-IBBE*(expx-E
     +BBE))
            Ibex_expi=IBEI*(1.0-WBE)
            Ibex_expn=IBEN*(1.0-WBE)
            Ibex_expx=-IBBE*(1.0-WBE)
            Ibex_Vbex=Ibex_expi*expi_Vbex
            Ibex_Vbex=Ibex_Vbex+Ibex_expn*expn_Vbex
            Ibex_Vbex=Ibex_Vbex+Ibex_expx*expx_Vbex
         else
            Ibex=(1.0-WBE)*(IBEI*(expi-1.0)+IBEN*(expn-1.0))
            Ibex_expi=IBEI*(1.0-WBE)
            Ibex_expn=IBEN*(1.0-WBE)
            Ibex_Vbex=Ibex_expi*expi_Vbex
            Ibex_Vbex=Ibex_Vbex+Ibex_expn*expn_Vbex
         endif
      endif
      argi=Vbci/(NCI*Vtv)
      argi_Vbci=1.0/(NCI*Vtv)
      expi=exp(argi)
      expi_argi=expi
      expi_Vbci=expi_argi*argi_Vbci
      argn=Vbci/(NCN*Vtv)
      argn_Vbci=1.0/(NCN*Vtv)
      expn=exp(argn)
      expn_argn=expn
      expn_Vbci=expn_argn*argn_Vbci
      Ibcj=IBCI*(expi-1.0)+IBCN*(expn-1.0)
      Ibcj_expi=IBCI
      Ibcj_expn=IBCN
      Ibcj_Vbci=Ibcj_expi*expi_Vbci
      Ibcj_Vbci=Ibcj_Vbci+Ibcj_expn*expn_Vbci
      if((IBEIP.GT.0.0).OR.(IBENP.GT.0.0))then
         argi=Vbep/(NCI*Vtv)
         argi_Vbep=1.0/(NCI*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbep=expi_argi*argi_Vbep
         argn=Vbep/(NCN*Vtv)
         argn_Vbep=1.0/(NCN*Vtv)
         expn=exp(argn)
         expn_argn=expn
         expn_Vbep=expn_argn*argn_Vbep
         Ibep=IBEIP*(expi-1.0)+IBENP*(expn-1.0)
         Ibep_expi=IBEIP
         Ibep_expn=IBENP
         Ibep_Vbep=Ibep_expi*expi_Vbep
         Ibep_Vbep=Ibep_Vbep+Ibep_expn*expn_Vbep
      else
         Ibep=0.0
         Ibep_Vbep=0.0
      endif
      if(AVC1.GT.0.0)then
         vl=0.5*(sqrt((PC-Vbci)*(PC-Vbci)+0.01)+(PC-Vbci))
         vl_Vbci=0.5*(-(PC-Vbci)/sqrt(((PC-Vbci)*(PC-Vbci))+0.01)-1.0)
         xvar2=(MC-1.0)
         xvar3=vl**xvar2
         xvar3_vl=xvar3*xvar2/vl
         xvar3_Vbci=xvar3_vl*vl_Vbci
         xvar1=-AVC2*xvar3
         xvar1_xvar3=-AVC2
         xvar1_Vbci=xvar1_xvar3*xvar3_Vbci
         xvar4=exp(xvar1)
         xvar4_xvar1=xvar4
         xvar4_Vbci=xvar4_xvar1*xvar1_Vbci
         avalf=AVC1*vl*xvar4
         avalf_vl=AVC1*xvar4
         avalf_xvar4=AVC1*vl
         avalf_Vbci=avalf_vl*vl_Vbci
         avalf_Vbci=avalf_Vbci+avalf_xvar4*xvar4_Vbci
         Igc=(Itxf-Itzr-Ibcj)*avalf
         Igc_Itxf=avalf
         Igc_Itzr=-avalf
         Igc_Ibcj=-avalf
         Igc_avalf=-Itzr+Itxf-Ibcj
         Igc_Vrxf=Igc_Itxf*Itxf_Vrxf
         Igc_Vbci=Igc_Itzr*Itzr_Vbci
         Igc_Vbei=Igc_Itzr*Itzr_Vbei
         Igc_Vbci=Igc_Vbci+Igc_Ibcj*Ibcj_Vbci
         Igc_Vbci=Igc_Vbci+Igc_avalf*avalf_Vbci
      else
         Igc=0.0
         Igc_Vrxf=0.0
         Igc_Vbci=0.0
         Igc_Vbei=0.0
      endif
      Ibc=Ibcj-Igc
      Ibc_Ibcj=1.0
      Ibc_Igc=-1.0
      Ibc_Vbci=Ibc_Ibcj*Ibcj_Vbci
      Ibc_Vrxf=Ibc_Igc*Igc_Vrxf
      Ibc_Vbci=Ibc_Vbci+Ibc_Igc*Igc_Vbci
      Ibc_Vbei=Ibc_Igc*Igc_Vbei
      if(RCX.GT.0.0)then
         Ircx=Vrcx/RCX
         Ircx_Vrcx=1.0/RCX
      else
         Ircx=0.0
         Ircx_Vrcx=0.0
      endif
      argi=Vbci/Vtv
      argi_Vbci=1.0/Vtv
      expi=exp(argi)
      expi_argi=expi
      expi_Vbci=expi_argi*argi_Vbci
      argx=Vbcx/Vtv
      argx_Vbcx=1.0/Vtv
      expx=exp(argx)
      expx_argx=expx
      expx_Vbcx=expx_argx*argx_Vbcx
      Kbci=sqrt(1.0+GAMM*expi)
      Kbci_expi=GAMM/(2.0*sqrt(expi*GAMM+1.0))
      Kbci_Vbci=Kbci_expi*expi_Vbci
      Kbcx=sqrt(1.0+GAMM*expx)
      Kbcx_expx=GAMM/(2.0*sqrt(expx*GAMM+1.0))
      Kbcx_Vbcx=Kbcx_expx*expx_Vbcx
      if(RCI.GT.0.0)then
         rKp1=(Kbci+1.0)/(Kbcx+1.0)
         rKp1_Kbci=1.0/(Kbcx+1.0)
         rKp1_Kbcx=-(Kbci+1.0)/((Kbcx+1.0)*(Kbcx+1.0))
         rKp1_Vbci=rKp1_Kbci*Kbci_Vbci
         rKp1_Vbcx=rKp1_Kbcx*Kbcx_Vbcx
         xvar1=log(rKp1)
         xvar1_rKp1=1.0/rKp1
         xvar1_Vbci=xvar1_rKp1*rKp1_Vbci
         xvar1_Vbcx=xvar1_rKp1*rKp1_Vbcx
         Iohm=(Vrci+Vtv*(Kbci-Kbcx-xvar1))/RCI
         Iohm_Vrci=1.0/RCI
         Iohm_Kbci=Vtv/RCI
         Iohm_Kbcx=-Vtv/RCI
         Iohm_xvar1=-Vtv/RCI
         Iohm_Vbci=Iohm_Kbci*Kbci_Vbci
         Iohm_Vbcx=Iohm_Kbcx*Kbcx_Vbcx
         Iohm_Vbci=Iohm_Vbci+Iohm_xvar1*xvar1_Vbci
         Iohm_Vbcx=Iohm_Vbcx+Iohm_xvar1*xvar1_Vbcx
         derf=IVO*RCI*Iohm/(1.0+0.5*IVO*IHRCF*sqrt(Vrci*Vrci+0.01))
         derf_Iohm=IVO*RCI/(0.5*IHRCF*IVO*sqrt((Vrci*Vrci)+0.01)+1.0)
         derf_Vrci=-0.5*IHRCF*Iohm*(IVO*IVO)*RCI*Vrci/(sqrt((Vrci*Vrci)+
     +0.01)*((0.5*IHRCF*IVO*sqrt((Vrci*Vrci)+0.01)+1.0)*(0.5*IHRCF*IVO*s
     +qrt((Vrci*Vrci)+0.01)+1.0)))
         derf_Vrci=derf_Vrci+derf_Iohm*Iohm_Vrci
         derf_Vbci=derf_Iohm*Iohm_Vbci
         derf_Vbcx=derf_Iohm*Iohm_Vbcx
         Irci=Iohm/sqrt(1.0+derf*derf)
         Irci_Iohm=1.0/sqrt((derf*derf)+1.0)
         Irci_derf=-derf*Iohm/(((derf*derf)+1.0)**(3.0/2.0))
         Irci_Vrci=Irci_Iohm*Iohm_Vrci
         Irci_Vbci=Irci_Iohm*Iohm_Vbci
         Irci_Vbcx=Irci_Iohm*Iohm_Vbcx
         Irci_Vrci=Irci_Vrci+Irci_derf*derf_Vrci
         Irci_Vbci=Irci_Vbci+Irci_derf*derf_Vbci
         Irci_Vbcx=Irci_Vbcx+Irci_derf*derf_Vbcx
      else
         Irci=0.0
         Irci_Vrci=0.0
         Irci_Vbci=0.0
         Irci_Vbcx=0.0
      endif
      if(RBX.GT.0.0)then
         Irbx=Vrbx/RBX
         Irbx_Vrbx=1.0/RBX
      else
         Irbx=0.0
         Irbx_Vrbx=0.0
      endif
      if(RBI.GT.0.0)then
         Irbi=Vrbi*qb/RBI
         Irbi_Vrbi=qb/RBI
         Irbi_qb=Vrbi/RBI
         Irbi_Vbei=Irbi_qb*qb_Vbei
         Irbi_Vbci=Irbi_qb*qb_Vbci
      else
         Irbi=0.0
         Irbi_Vrbi=0.0
         Irbi_Vbei=0.0
         Irbi_Vbci=0.0
      endif
      if(RE.GT.0.0)then
         Ire=Vre/RE
         Ire_Vre=1.0/RE
      else
         Ire=0.0
         Ire_Vre=0.0
      endif
      if(RBP.GT.0.0)then
         Irbp=Vrbp*qbp/RBP
         Irbp_Vrbp=qbp/RBP
         Irbp_qbp=Vrbp/RBP
         Irbp_Vbep=Irbp_qbp*qbp_Vbep
         Irbp_Vbci=Irbp_qbp*qbp_Vbci
      else
         Irbp=0.0
         Irbp_Vrbp=0.0
         Irbp_Vbep=0.0
         Irbp_Vbci=0.0
      endif
      if((IBCIP.GT.0.0).OR.(IBCNP.GT.0.0))then
         argi=Vbcp/(NCIP*Vtv)
         argi_Vbcp=1.0/(NCIP*Vtv)
         expi=exp(argi)
         expi_argi=expi
         expi_Vbcp=expi_argi*argi_Vbcp
         argn=Vbcp/(NCNP*Vtv)
         argn_Vbcp=1.0/(NCNP*Vtv)
         expn=exp(argn)
         expn_argn=expn
         expn_Vbcp=expn_argn*argn_Vbcp
         Ibcp=IBCIP*(expi-1.0)+IBCNP*(expn-1.0)
         Ibcp_expi=IBCIP
         Ibcp_expn=IBCNP
         Ibcp_Vbcp=Ibcp_expi*expi_Vbcp
         Ibcp_Vbcp=Ibcp_Vbcp+Ibcp_expn*expn_Vbcp
      else
         Ibcp=0.0
         Ibcp_Vbcp=0.0
      endif
      if(RS.GT.0.0)then
         Irs=Vrs/RS
         Irs_Vrs=1.0/RS
      else
         Irs=0.0
         Irs_Vrs=0.0
      endif
      if(Ifi.GT.0.0)then
         sgIf=1.0
      else
         sgIf=0.0
      endif
      rIf=Ifi*sgIf*IITF
      rIf_Ifi=IITF*sgIf
      rIf_Vbei=rIf_Ifi*Ifi_Vbei
      mIf=rIf/(rIf+1.0)
      mIf_rIf=1.0/(rIf+1.0)-rIf/((rIf+1.0)*(rIf+1.0))
      mIf_Vbei=mIf_rIf*rIf_Vbei
      xvar1=Vbci*IVTF/1.44
      xvar1_Vbci=0.6944444*IVTF
      xvar2=exp(xvar1)
      xvar2_xvar1=xvar2
      xvar2_Vbci=xvar2_xvar1*xvar1_Vbci
      tff=TF*(1.0+QTF*q1)*(1.0+XTF*xvar2*(slTF+mIf*mIf)*sgIf)
      tff_q1=QTF*TF*(sgIf*(slTF+(mIf*mIf))*XTF*xvar2+1.0)
      tff_xvar2=(q1*QTF+1.0)*sgIf*(slTF+(mIf*mIf))*TF*XTF
      tff_mIf=2.0*mIf*(q1*QTF+1.0)*sgIf*TF*XTF*xvar2
      tff_Vbei=tff_q1*q1_Vbei
      tff_Vbci=tff_q1*q1_Vbci
      tff_Vbci=tff_Vbci+tff_xvar2*xvar2_Vbci
      tff_Vbei=tff_Vbei+tff_mIf*mIf_Vbei
      Qbe=CJE*qdbe*WBE+tff*Ifi/qb
      Qbe_qdbe=CJE*WBE
      Qbe_tff=Ifi/qb
      Qbe_Ifi=tff/qb
      Qbe_qb=-Ifi*tff/(qb*qb)
      Qbe_Vbei=Qbe_qdbe*qdbe_Vbei
      Qbe_Vbei=Qbe_Vbei+Qbe_tff*tff_Vbei
      Qbe_Vbci=Qbe_tff*tff_Vbci
      Qbe_Vbei=Qbe_Vbei+Qbe_Ifi*Ifi_Vbei
      Qbe_Vbei=Qbe_Vbei+Qbe_qb*qb_Vbei
      Qbe_Vbci=Qbe_Vbci+Qbe_qb*qb_Vbci
      Qbex=CJE*qdbex*(1.0-WBE)
      Qbex_qdbex=CJE*(1.0-WBE)
      Qbex_Vbex=Qbex_qdbex*qdbex_Vbex
      Qbc=CJC*qdbc+TR*Iri+QCO*Kbci
      Qbc_qdbc=CJC
      Qbc_Iri=TR
      Qbc_Kbci=QCO
      Qbc_Vbci=Qbc_qdbc*qdbc_Vbci
      Qbc_Vbci=Qbc_Vbci+Qbc_Iri*Iri_Vbci
      Qbc_Vbci=Qbc_Vbci+Qbc_Kbci*Kbci_Vbci
      Qbcx=QCO*Kbcx
      Qbcx_Kbcx=QCO
      Qbcx_Vbcx=Qbcx_Kbcx*Kbcx_Vbcx
      Qbep=CJEP*qdbep+TR*Ifp
      Qbep_qdbep=CJEP
      Qbep_Ifp=TR
      Qbep_Vbep=Qbep_qdbep*qdbep_Vbep
      Qbep_Vbep=Qbep_Vbep+Qbep_Ifp*Ifp_Vbep
      Qbep_Vbci=Qbep_Ifp*Ifp_Vbci
      Qbcp=CJCP*qdbcp+CCSO*Vbcp
      Qbcp_qdbcp=CJCP
      Qbcp_Vbcp=CCSO
      Qbcp_Vbcp=Qbcp_Vbcp+Qbcp_qdbcp*qdbcp_Vbcp
      Qbeo=Vbe*CBEO
      Qbeo_Vbe=CBEO
      Qbco=Vbc*CBCO
      Qbco_Vbc=CBCO
      Flxf=LEP*Ixxf
      Flxf_Ixxf=LEP
      Flxf_Vrxf=Flxf_Ixxf*Ixxf_Vrxf
      Qcxf=CEP*Vcxf
      Qcxf_Vcxf=CEP
c
c     Scale outputs
c
      if(SCALE.NE.1.0)then
         Ibe=SCALE*Ibe
         Ibe_Vbei=SCALE*Ibe_Vbei
         Ibex=SCALE*Ibex
         Ibex_Vbex=SCALE*Ibex_Vbex
         Itxf=SCALE*Itxf
         Itxf_Vrxf=SCALE*Itxf_Vrxf
         Itzr=SCALE*Itzr
         Itzr_Vbci=SCALE*Itzr_Vbci
         Itzr_Vbei=SCALE*Itzr_Vbei
         Ibc=SCALE*Ibc
         Ibc_Vbci=SCALE*Ibc_Vbci
         Ibc_Vrxf=SCALE*Ibc_Vrxf
         Ibc_Vbei=SCALE*Ibc_Vbei
         Ibep=SCALE*Ibep
         Ibep_Vbep=SCALE*Ibep_Vbep
         Ircx=SCALE*Ircx
         Ircx_Vrcx=SCALE*Ircx_Vrcx
         Irci=SCALE*Irci
         Irci_Vrci=SCALE*Irci_Vrci
         Irci_Vbci=SCALE*Irci_Vbci
         Irci_Vbcx=SCALE*Irci_Vbcx
         Irbx=SCALE*Irbx
         Irbx_Vrbx=SCALE*Irbx_Vrbx
         Irbi=SCALE*Irbi
         Irbi_Vrbi=SCALE*Irbi_Vrbi
         Irbi_Vbei=SCALE*Irbi_Vbei
         Irbi_Vbci=SCALE*Irbi_Vbci
         Ire=SCALE*Ire
         Ire_Vre=SCALE*Ire_Vre
         Irbp=SCALE*Irbp
         Irbp_Vrbp=SCALE*Irbp_Vrbp
         Irbp_Vbep=SCALE*Irbp_Vbep
         Irbp_Vbci=SCALE*Irbp_Vbci
         Qbe=SCALE*Qbe
         Qbe_Vbei=SCALE*Qbe_Vbei
         Qbe_Vbci=SCALE*Qbe_Vbci
         Qbex=SCALE*Qbex
         Qbex_Vbex=SCALE*Qbex_Vbex
         Qbc=SCALE*Qbc
         Qbc_Vbci=SCALE*Qbc_Vbci
         Qbcx=SCALE*Qbcx
         Qbcx_Vbcx=SCALE*Qbcx_Vbcx
         Qbep=SCALE*Qbep
         Qbep_Vbep=SCALE*Qbep_Vbep
         Qbep_Vbci=SCALE*Qbep_Vbci
         Qbeo=SCALE*Qbeo
         Qbeo_Vbe=SCALE*Qbeo_Vbe
         Qbco=SCALE*Qbco
         Qbco_Vbc=SCALE*Qbco_Vbc
         Ibcp=SCALE*Ibcp
         Ibcp_Vbcp=SCALE*Ibcp_Vbcp
         Iccp=SCALE*Iccp
         Iccp_Vbep=SCALE*Iccp_Vbep
         Iccp_Vbci=SCALE*Iccp_Vbci
         Iccp_Vbcp=SCALE*Iccp_Vbcp
         Irs=SCALE*Irs
         Irs_Vrs=SCALE*Irs_Vrs
         Qbcp=SCALE*Qbcp
         Qbcp_Vbcp=SCALE*Qbcp_Vbcp
         Ixzf=SCALE*Ixzf
         Ixzf_Vbei=SCALE*Ixzf_Vbei
         Ixzf_Vbci=SCALE*Ixzf_Vbci
         Ixxf=SCALE*Ixxf
         Ixxf_Vrxf=SCALE*Ixxf_Vrxf
         Qcxf=SCALE*Qcxf
         Qcxf_Vcxf=SCALE*Qcxf_Vcxf
         Flxf=SCALE*Flxf
         Flxf_Vrxf=SCALE*Flxf_Vrxf
      endif
      return
      end
